---
interface Props {
  id?: string;
  title?: string;
  defaultTaxRate?: number;
  currency?: string;
}

const {
  id = 'invoice-generator',
  title = 'Invoice Generator',
  defaultTaxRate = 13,
  currency = 'CAD'
} = Astro.props;
---

<section
  id={id}
  data-invoice-generator
  data-default-tax-rate={defaultTaxRate}
  data-currency={currency}
  class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 sm:p-6"
>
  <!-- Document Type Selector -->
  <div class="flex flex-wrap items-center gap-3 mb-5">
    <div class="flex rounded-lg border border-slate-200 dark:border-slate-600 overflow-hidden" data-doc-type-group>
      <button type="button" data-doc-type="estimate" class="doc-type-btn px-4 py-2 text-sm font-semibold bg-primary-600 text-white">
        Estimate
      </button>
      <button type="button" data-doc-type="quote" class="doc-type-btn px-4 py-2 text-sm font-semibold bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 border-l border-slate-200 dark:border-slate-600">
        Quote
      </button>
      <button type="button" data-doc-type="invoice" class="doc-type-btn px-4 py-2 text-sm font-semibold bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 border-l border-slate-200 dark:border-slate-600">
        Invoice
      </button>
    </div>
    <span data-doc-badge class="text-xs font-semibold px-2.5 py-1 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300">DRAFT</span>
    <span class="ml-auto text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">{currency}</span>
  </div>

  <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-5" data-doc-title>{title}</h2>

  <!-- From / To Details -->
  <div class="grid md:grid-cols-2 gap-6 mb-5">
    <!-- FROM — Your Business -->
    <div class="space-y-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 p-4">
      <h3 class="text-xs font-bold uppercase tracking-wide text-slate-500 dark:text-slate-400">From (Your Business)</h3>
      <label class="text-sm block">
        <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium">Business Name</span>
        <input data-field="businessName" type="text" placeholder="Your Company Inc." class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white" />
      </label>
      <label class="text-sm block">
        <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium">Address</span>
        <input data-field="businessAddress" type="text" placeholder="123 Main St, Toronto, ON M5V 1A1" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white" />
      </label>
      <div class="grid grid-cols-2 gap-3">
        <label class="text-sm block">
          <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium">Phone</span>
          <input data-field="businessPhone" type="tel" placeholder="(416) 555-0100" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white" />
        </label>
        <label class="text-sm block">
          <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium">Email</span>
          <input data-field="businessEmail" type="email" placeholder="info@company.ca" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white" />
        </label>
      </div>
      <label class="text-sm block">
        <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium">GST/HST # <span class="font-normal text-slate-400">(optional)</span></span>
        <input data-field="taxNumber" type="text" placeholder="123456789RT0001" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white" />
      </label>
    </div>

    <!-- TO — Client -->
    <div class="space-y-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 p-4">
      <h3 class="text-xs font-bold uppercase tracking-wide text-slate-500 dark:text-slate-400">To (Client)</h3>
      <label class="text-sm block">
        <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium">Client Name</span>
        <input data-field="clientName" type="text" placeholder="Client Name" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white" />
      </label>
      <label class="text-sm block">
        <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium">Client Address</span>
        <input data-field="clientAddress" type="text" placeholder="456 Oak Ave, Ottawa, ON K1A 0B1" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white" />
      </label>
      <label class="text-sm block">
        <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium">Client Email <span class="font-normal text-slate-400">(optional)</span></span>
        <input data-field="clientEmail" type="email" placeholder="client@example.com" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white" />
      </label>
    </div>
  </div>

  <!-- Document Details Row -->
  <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
    <label class="text-sm">
      <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium" data-number-label>Estimate #</span>
      <input data-field="invoiceNumber" type="text" placeholder="EST-1001" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white" />
    </label>
    <label class="text-sm">
      <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium">Date</span>
      <input data-field="docDate" type="date" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white" />
    </label>
    <label class="text-sm">
      <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium" data-due-label>Valid Until</span>
      <input data-field="dueDate" type="date" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white" />
    </label>
    <label class="text-sm">
      <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium">Payment Terms</span>
      <select data-field="paymentTerms" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white">
        <option value="Due on receipt">Due on Receipt</option>
        <option value="Net 15">Net 15</option>
        <option value="Net 30" selected>Net 30</option>
        <option value="Net 45">Net 45</option>
        <option value="Net 60">Net 60</option>
        <option value="Custom">Custom (see notes)</option>
      </select>
    </label>
  </div>

  <!-- Tax Rate -->
  <div class="grid sm:grid-cols-4 gap-4 mb-5">
    <label class="text-sm">
      <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium">Tax Rate (%)</span>
      <input data-field="taxRate" type="number" min="0" max="100" step="0.1" value={defaultTaxRate} class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-slate-900 dark:text-white" />
    </label>
  </div>

  <!-- Line Items Table -->
  <div class="overflow-x-auto mb-4">
    <table class="w-full min-w-[680px] border-collapse">
      <thead>
        <tr class="bg-slate-50 dark:bg-slate-900">
          <th class="text-left text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 p-3 border border-slate-200 dark:border-slate-700">Description</th>
          <th class="text-right text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 p-3 border border-slate-200 dark:border-slate-700">Qty</th>
          <th class="text-right text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 p-3 border border-slate-200 dark:border-slate-700">Rate</th>
          <th class="text-right text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 p-3 border border-slate-200 dark:border-slate-700">Amount</th>
          <th class="text-right text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 p-3 border border-slate-200 dark:border-slate-700">Action</th>
        </tr>
      </thead>
      <tbody data-items-body>
        <tr data-line-item>
          <td class="p-2 border border-slate-200 dark:border-slate-700">
            <input data-role="description" type="text" placeholder="Service or item" class="w-full rounded-md border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-2 py-1.5 text-sm text-slate-900 dark:text-white" />
          </td>
          <td class="p-2 border border-slate-200 dark:border-slate-700">
            <input data-role="qty" type="number" min="0" step="1" value="1" class="w-full rounded-md border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-2 py-1.5 text-sm text-right text-slate-900 dark:text-white" />
          </td>
          <td class="p-2 border border-slate-200 dark:border-slate-700">
            <input data-role="rate" type="number" min="0" step="0.01" value="0" class="w-full rounded-md border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-2 py-1.5 text-sm text-right text-slate-900 dark:text-white" />
          </td>
          <td class="p-2 border border-slate-200 dark:border-slate-700 text-right text-sm font-semibold text-slate-900 dark:text-white">
            <span data-role="amount">0.00</span>
          </td>
          <td class="p-2 border border-slate-200 dark:border-slate-700 text-right">
            <button type="button" data-action="remove-line" class="text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">
              Remove
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="flex flex-wrap gap-2 mb-6">
    <button type="button" data-action="add-line" class="inline-flex items-center px-3 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-semibold">
      Add Line Item
    </button>
    <button type="button" data-action="reset" class="inline-flex items-center px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 text-sm font-semibold text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700">
      Reset
    </button>
  </div>

  <!-- Notes / Terms -->
  <div class="mb-6">
    <label class="text-sm">
      <span class="block mb-1 text-slate-700 dark:text-slate-300 font-medium">Notes / Terms</span>
      <textarea data-field="notes" rows="3" placeholder="Payment terms, additional notes, or terms & conditions..." class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-sm text-slate-900 dark:text-white resize-y"></textarea>
    </label>
  </div>

  <!-- Totals -->
  <div class="ml-auto max-w-sm space-y-2 text-sm">
    <div class="flex justify-between items-center">
      <span class="text-slate-600 dark:text-slate-400">Subtotal</span>
      <strong data-total="subtotal" class="text-slate-900 dark:text-white">0.00</strong>
    </div>
    <div class="flex justify-between items-center">
      <span class="text-slate-600 dark:text-slate-400">Tax</span>
      <strong data-total="tax" class="text-slate-900 dark:text-white">0.00</strong>
    </div>
    <div class="flex justify-between items-center border-t border-slate-200 dark:border-slate-700 pt-2">
      <span class="text-base font-semibold text-slate-900 dark:text-white">Total</span>
      <strong data-total="grand" class="text-base font-bold text-slate-900 dark:text-white">0.00</strong>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="flex flex-wrap gap-2 mt-6">
    <button type="button" data-action="download-pdf" class="inline-flex items-center px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-semibold">
      Download PDF
    </button>
    <button type="button" data-action="print" class="inline-flex items-center px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 text-sm font-semibold text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700">
      Print
    </button>
  </div>
</section>

<script is:inline>
  (function initInvoiceGenerators() {
    var containers = document.querySelectorAll('[data-invoice-generator]');
    if (!containers.length) return;

    var parseNum = function(value) {
      var num = Number(value);
      return Number.isFinite(num) ? num : 0;
    };

    var escapeName = function(value) {
      return value.replace(/[^a-zA-Z0-9_-]/g, '');
    };

    var formatCurrency = function(value, currency) {
      return new Intl.NumberFormat('en-CA', {
        style: 'currency',
        currency: currency || 'CAD',
        maximumFractionDigits: 2,
      }).format(value || 0);
    };

    var DOC_TYPE_CONFIG = {
      estimate: { label: 'Estimate', numberLabel: 'Estimate #', placeholder: 'EST-1001', dueLabel: 'Valid Until', badge: 'DRAFT', badgeClass: 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300' },
      quote:    { label: 'Quote',    numberLabel: 'Quote #',    placeholder: 'QT-1001',  dueLabel: 'Valid Until', badge: 'DRAFT', badgeClass: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' },
      invoice:  { label: 'Invoice',  numberLabel: 'Invoice #',  placeholder: 'INV-1001', dueLabel: 'Due Date',    badge: 'UNPAID', badgeClass: 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300' }
    };

    var makeLineItemRow = function() {
      var row = document.createElement('tr');
      row.setAttribute('data-line-item', '');
      row.innerHTML = [
        '<td class="p-2 border border-slate-200 dark:border-slate-700"><input data-role="description" type="text" placeholder="Service or item" class="w-full rounded-md border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-2 py-1.5 text-sm text-slate-900 dark:text-white" /></td>',
        '<td class="p-2 border border-slate-200 dark:border-slate-700"><input data-role="qty" type="number" min="0" step="1" value="1" class="w-full rounded-md border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-2 py-1.5 text-sm text-right text-slate-900 dark:text-white" /></td>',
        '<td class="p-2 border border-slate-200 dark:border-slate-700"><input data-role="rate" type="number" min="0" step="0.01" value="0" class="w-full rounded-md border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-2 py-1.5 text-sm text-right text-slate-900 dark:text-white" /></td>',
        '<td class="p-2 border border-slate-200 dark:border-slate-700 text-right text-sm font-semibold text-slate-900 dark:text-white"><span data-role="amount">0.00</span></td>',
        '<td class="p-2 border border-slate-200 dark:border-slate-700 text-right"><button type="button" data-action="remove-line" class="text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">Remove</button></td>'
      ].join('');
      return row;
    };

    containers.forEach(function(container) {
      if (container.getAttribute('data-initialized') === 'true') return;
      container.setAttribute('data-initialized', 'true');

      var currency = container.getAttribute('data-currency') || 'CAD';
      var currentDocType = 'estimate';
      var itemsBody = container.querySelector('[data-items-body]');
      var taxRateInput = container.querySelector('[data-field="taxRate"]');
      var subtotalEl = container.querySelector('[data-total="subtotal"]');
      var taxEl = container.querySelector('[data-total="tax"]');
      var grandEl = container.querySelector('[data-total="grand"]');
      var addBtn = container.querySelector('[data-action="add-line"]');
      var resetBtn = container.querySelector('[data-action="reset"]');
      var downloadPdfBtn = container.querySelector('[data-action="download-pdf"]');
      var printBtn = container.querySelector('[data-action="print"]');
      var docBadge = container.querySelector('[data-doc-badge]');
      var docTitle = container.querySelector('[data-doc-title]');
      var numberLabel = container.querySelector('[data-number-label]');
      var dueLabel = container.querySelector('[data-due-label]');
      var docTypeBtns = container.querySelectorAll('[data-doc-type]');

      if (!itemsBody || !taxRateInput || !subtotalEl || !taxEl || !grandEl) return;

      // Set today's date as default
      var docDateInput = container.querySelector('[data-field="docDate"]');
      if (docDateInput && !docDateInput.value) {
        docDateInput.value = new Date().toISOString().split('T')[0];
      }

      // Set default due date (30 days from now)
      var dueDateInput = container.querySelector('[data-field="dueDate"]');
      if (dueDateInput && !dueDateInput.value) {
        var futureDate = new Date();
        futureDate.setDate(futureDate.getDate() + 30);
        dueDateInput.value = futureDate.toISOString().split('T')[0];
      }

      var setDocType = function(type) {
        currentDocType = type;
        var cfg = DOC_TYPE_CONFIG[type];

        docTypeBtns.forEach(function(btn) {
          if (btn.getAttribute('data-doc-type') === type) {
            btn.className = 'doc-type-btn px-4 py-2 text-sm font-semibold bg-primary-600 text-white';
          } else {
            btn.className = 'doc-type-btn px-4 py-2 text-sm font-semibold bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 border-l border-slate-200 dark:border-slate-600';
          }
        });

        if (docBadge) {
          docBadge.textContent = cfg.badge;
          docBadge.className = 'text-xs font-semibold px-2.5 py-1 rounded-full ' + cfg.badgeClass;
        }
        if (numberLabel) numberLabel.textContent = cfg.numberLabel;
        if (dueLabel) dueLabel.textContent = cfg.dueLabel;

        var numInput = container.querySelector('[data-field="invoiceNumber"]');
        if (numInput) numInput.setAttribute('placeholder', cfg.placeholder);
      };

      docTypeBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          setDocType(btn.getAttribute('data-doc-type'));
        });
      });

      setDocType('estimate');

      var recalc = function() {
        var subtotal = 0;
        var rows = container.querySelectorAll('[data-line-item]');
        rows.forEach(function(row) {
          var qtyInput = row.querySelector('[data-role="qty"]');
          var rateInput = row.querySelector('[data-role="rate"]');
          var amountEl = row.querySelector('[data-role="amount"]');
          var qty = parseNum(qtyInput && qtyInput.value);
          var rate = parseNum(rateInput && rateInput.value);
          var amount = qty * rate;
          subtotal += amount;
          if (amountEl) amountEl.textContent = amount.toFixed(2);
        });

        var taxRate = parseNum(taxRateInput.value) / 100;
        var tax = subtotal * taxRate;
        var grand = subtotal + tax;

        subtotalEl.textContent = formatCurrency(subtotal, currency);
        taxEl.textContent = formatCurrency(tax, currency);
        grandEl.textContent = formatCurrency(grand, currency);
      };

      var bindRowEvents = function(row) {
        row.querySelectorAll('input').forEach(function(input) {
          input.addEventListener('input', recalc);
        });
        var removeBtn = row.querySelector('[data-action="remove-line"]');
        if (removeBtn) {
          removeBtn.addEventListener('click', function() {
            var totalRows = container.querySelectorAll('[data-line-item]').length;
            if (totalRows <= 1) return;
            row.remove();
            recalc();
          });
        }
      };

      container.querySelectorAll('[data-line-item]').forEach(bindRowEvents);
      taxRateInput.addEventListener('input', recalc);

      if (addBtn) {
        addBtn.addEventListener('click', function() {
          var row = makeLineItemRow();
          itemsBody.appendChild(row);
          bindRowEvents(row);
          recalc();
        });
      }

      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          var defaultTaxRate = container.getAttribute('data-default-tax-rate') || '13';
          container.querySelectorAll('[data-line-item]').forEach(function(row, idx) {
            if (idx > 0) row.remove();
          });
          var firstRow = container.querySelector('[data-line-item]');
          if (firstRow) {
            firstRow.querySelectorAll('input').forEach(function(input) {
              input.value = input.getAttribute('data-role') === 'qty' ? '1' : '0';
            });
            var desc = firstRow.querySelector('[data-role="description"]');
            if (desc) desc.value = '';
          }
          container.querySelectorAll('[data-field]').forEach(function(field) {
            var name = field.getAttribute('data-field');
            if (name === 'taxRate') {
              field.value = defaultTaxRate;
            } else if (name === 'docDate') {
              field.value = new Date().toISOString().split('T')[0];
            } else if (name === 'dueDate') {
              var d = new Date(); d.setDate(d.getDate() + 30);
              field.value = d.toISOString().split('T')[0];
            } else if (name === 'paymentTerms') {
              field.value = 'Net 30';
            } else if (name === 'notes') {
              field.value = '';
            } else {
              field.value = '';
            }
          });
          setDocType('estimate');
          recalc();
        });
      }

      // Helper to get a field value
      var getField = function(name) {
        return (container.querySelector('[data-field="' + name + '"]') || {}).value || '';
      };

      // Gather all data from form
      var gatherData = function() {
        var taxRate = parseNum(taxRateInput.value);
        var items = [];
        container.querySelectorAll('[data-line-item]').forEach(function(row) {
          var desc = (row.querySelector('[data-role="description"]') || {}).value || 'Line item';
          var qty = parseNum((row.querySelector('[data-role="qty"]') || {}).value);
          var rate = parseNum((row.querySelector('[data-role="rate"]') || {}).value);
          items.push({ description: desc, qty: qty, rate: rate, amount: qty * rate });
        });
        var subtotal = items.reduce(function(s, i) { return s + i.amount; }, 0);
        var tax = subtotal * (taxRate / 100);
        var grand = subtotal + tax;
        var cfg = DOC_TYPE_CONFIG[currentDocType];
        return {
          docType: currentDocType,
          docLabel: cfg.label,
          businessName: getField('businessName'),
          businessAddress: getField('businessAddress'),
          businessPhone: getField('businessPhone'),
          businessEmail: getField('businessEmail'),
          taxNumber: getField('taxNumber'),
          clientName: getField('clientName'),
          clientAddress: getField('clientAddress'),
          clientEmail: getField('clientEmail'),
          invoiceNumber: getField('invoiceNumber'),
          docDate: getField('docDate'),
          dueDate: getField('dueDate'),
          dueLabel: cfg.dueLabel,
          paymentTerms: getField('paymentTerms'),
          notes: getField('notes'),
          taxRate: taxRate,
          items: items,
          subtotal: subtotal,
          tax: tax,
          grand: grand
        };
      };

      // Build PDF document (shared by download and print)
      // Lazy-load jsPDF on first use (avoids render-blocking CDN script)
      var jsPDFPromise = null;
      var loadJsPdf = function() {
        if (window.jspdf) return Promise.resolve(window.jspdf.jsPDF);
        if (jsPDFPromise) return jsPDFPromise;
        jsPDFPromise = new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          s.onload = function() { resolve(window.jspdf.jsPDF); };
          s.onerror = function() { jsPDFPromise = null; reject(new Error('Failed to load PDF library')); };
          document.head.appendChild(s);
        });
        return jsPDFPromise;
      };

      var buildPdf = function(callback) {
        loadJsPdf().then(function(jsPDF) {
          var result = buildPdfWithLib(jsPDF);
          callback(result);
        }).catch(function() {
          alert('Could not load the PDF library. Please check your internet connection and try again.');
        });
      };

      var buildPdfWithLib = function(jsPDF) {
        var d = gatherData();
        var doc = new jsPDF({ unit: 'mm', format: 'letter' });
        var pageW = doc.internal.pageSize.getWidth();
        var margin = 20;
        var contentW = pageW - margin * 2;
        var y = margin;
        var dash = '\u2014';

        var primary = [37, 99, 235];
        var dark = [15, 23, 42];
        var mid = [100, 116, 139];
        var light = [241, 245, 249];

        // Header accent bar
        doc.setFillColor(primary[0], primary[1], primary[2]);
        doc.rect(0, 0, pageW, 14, 'F');

        // Document title + number
        y = 28;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(22);
        doc.setTextColor(dark[0], dark[1], dark[2]);
        doc.text(d.docLabel.toUpperCase(), margin, y);

        doc.setFontSize(11);
        doc.setTextColor(mid[0], mid[1], mid[2]);
        doc.text(d.docLabel + ' #: ' + (d.invoiceNumber || 'N/A'), pageW - margin, y, { align: 'right' });

        // FROM section
        y += 14;
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(mid[0], mid[1], mid[2]);
        doc.text('FROM', margin, y);
        doc.text('TO', margin + contentW * 0.5, y);

        y += 5;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.setTextColor(dark[0], dark[1], dark[2]);

        // From details
        var fromY = y;
        doc.setFont('helvetica', 'bold');
        doc.text(d.businessName || dash, margin, fromY);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        if (d.businessAddress) { fromY += 4.5; doc.text(d.businessAddress, margin, fromY); }
        if (d.businessPhone || d.businessEmail) {
          fromY += 4.5;
          var contactLine = [d.businessPhone, d.businessEmail].filter(Boolean).join(' | ');
          doc.text(contactLine, margin, fromY);
        }
        if (d.taxNumber) {
          fromY += 4.5;
          doc.setTextColor(mid[0], mid[1], mid[2]);
          doc.text('GST/HST #: ' + d.taxNumber, margin, fromY);
          doc.setTextColor(dark[0], dark[1], dark[2]);
        }

        // To details
        var toX = margin + contentW * 0.5;
        var toY = y;
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text(d.clientName || dash, toX, toY);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        if (d.clientAddress) { toY += 4.5; doc.text(d.clientAddress, toX, toY); }
        if (d.clientEmail) { toY += 4.5; doc.text(d.clientEmail, toX, toY); }

        y = Math.max(fromY, toY) + 8;

        // Date / Due / Terms row
        doc.setFontSize(9);
        doc.setTextColor(mid[0], mid[1], mid[2]);
        doc.text('Date: ' + (d.docDate || dash), margin, y);
        doc.text(d.dueLabel + ': ' + (d.dueDate || dash), margin + contentW * 0.33, y);
        doc.text('Terms: ' + (d.paymentTerms || dash), margin + contentW * 0.66, y);

        // Divider
        y += 6;
        doc.setDrawColor(226, 232, 240);
        doc.setLineWidth(0.3);
        doc.line(margin, y, pageW - margin, y);

        // Table header
        y += 7;
        var colX = [margin, margin + contentW * 0.55, margin + contentW * 0.7, margin + contentW * 0.85];
        doc.setFillColor(light[0], light[1], light[2]);
        doc.rect(margin, y - 4, contentW, 8, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.setTextColor(mid[0], mid[1], mid[2]);
        doc.text('DESCRIPTION', colX[0] + 2, y);
        doc.text('QTY', colX[1], y, { align: 'right' });
        doc.text('RATE', colX[2], y, { align: 'right' });
        doc.text('AMOUNT', pageW - margin, y, { align: 'right' });

        // Table rows
        y += 8;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.setTextColor(dark[0], dark[1], dark[2]);
        d.items.forEach(function(item) {
          if (y > 235) {
            doc.addPage();
            y = margin;
          }
          doc.text(String(item.description).substring(0, 50), colX[0] + 2, y);
          doc.text(String(item.qty), colX[1], y, { align: 'right' });
          doc.text(formatCurrency(item.rate, currency), colX[2], y, { align: 'right' });
          doc.text(formatCurrency(item.amount, currency), pageW - margin, y, { align: 'right' });
          y += 7;
        });

        // Divider before totals
        y += 2;
        doc.setDrawColor(226, 232, 240);
        doc.setLineWidth(0.3);
        doc.line(margin + contentW * 0.55, y, pageW - margin, y);

        // Totals
        y += 7;
        var totalsX = margin + contentW * 0.7;
        doc.setFontSize(10);
        doc.setTextColor(mid[0], mid[1], mid[2]);
        doc.text('Subtotal', totalsX, y);
        doc.setTextColor(dark[0], dark[1], dark[2]);
        doc.text(formatCurrency(d.subtotal, currency), pageW - margin, y, { align: 'right' });

        y += 6;
        doc.setTextColor(mid[0], mid[1], mid[2]);
        doc.text('Tax (' + d.taxRate.toFixed(1) + '%)', totalsX, y);
        doc.setTextColor(dark[0], dark[1], dark[2]);
        doc.text(formatCurrency(d.tax, currency), pageW - margin, y, { align: 'right' });

        y += 2;
        doc.setDrawColor(dark[0], dark[1], dark[2]);
        doc.setLineWidth(0.5);
        doc.line(totalsX, y, pageW - margin, y);

        y += 6;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(13);
        doc.text('Total: ' + formatCurrency(d.grand, currency), pageW - margin, y, { align: 'right' });

        // Notes
        if (d.notes) {
          y += 14;
          if (y > 235) { doc.addPage(); y = margin; }
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setTextColor(mid[0], mid[1], mid[2]);
          doc.text('NOTES / TERMS', margin, y);
          y += 5;
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9);
          doc.setTextColor(dark[0], dark[1], dark[2]);
          var noteLines = doc.splitTextToSize(d.notes, contentW);
          doc.text(noteLines, margin, y);
        }

        // Footer
        var footY = doc.internal.pageSize.getHeight() - 12;
        doc.setFontSize(7);
        doc.setTextColor(mid[0], mid[1], mid[2]);
        doc.text('Generated with Lead Flow North Free Tools \u2014 leadflownorth.com', pageW / 2, footY, { align: 'center' });

        return { doc: doc, data: d };
      };

      // PDF download
      if (downloadPdfBtn) {
        downloadPdfBtn.addEventListener('click', function() {
          buildPdf(function(result) {
            if (!result) return;
            var fname = (result.data.invoiceNumber || result.data.docType).trim();
            result.doc.save((fname.length > 0 ? escapeName(fname) : result.data.docType) + '.pdf');
          });
        });
      }

      // Print — opens the generated PDF in a new tab and triggers print dialog
      if (printBtn) {
        printBtn.addEventListener('click', function() {
          buildPdf(function(result) {
            if (!result) return;
            var pdfBlob = result.doc.output('blob');
            var blobUrl = URL.createObjectURL(pdfBlob);
            var printWindow = window.open(blobUrl, '_blank');
            if (printWindow) {
              printWindow.addEventListener('load', function() {
                printWindow.focus();
                printWindow.print();
              });
            }
          });
        });
      }

      recalc();
    });
  })();
</script>
