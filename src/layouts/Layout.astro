---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';

interface Props {
  title: string;
  description?: string;
  canonicalURL?: string;
  ogImage?: string;
  noIndex?: boolean;
  structuredData?: object;
  showBreadcrumbs?: boolean;
  breadcrumbs?: Array<{ name: string; href?: string }>;
}

// Default description for pages that don't specify one
const defaultDescription = 'Lead Flow North helps Canadian small businesses grow with web design, SEO, and marketing automation. Get more leads and customers in Ontario, Alberta, and across Canada.';

const { 
  title, 
  description = defaultDescription, 
  canonicalURL,
  ogImage = '/og-default.svg',
  noIndex = false,
  structuredData,
  showBreadcrumbs = true,
  breadcrumbs
} = Astro.props;

// Don't show breadcrumbs on homepage
const shouldShowBreadcrumbs = showBreadcrumbs && Astro.url.pathname !== '/';

// Build hreflang URLs
const baseUrl = 'https://leadflownorth.com';
const currentPath = Astro.url.pathname;

const siteName = 'Lead Flow North';
const titleHasBrand = /lead flow north/i.test(title);
const fullTitle = title === 'Home'
  ? `${siteName} | Web Design & Marketing for Canadian Small Businesses`
  : (titleHasBrand ? title : `${title} | ${siteName}`);
const resolvedCanonicalURL = canonicalURL
  ? new URL(canonicalURL, baseUrl).toString()
  : `${baseUrl}${currentPath}`;
const resolvedOgImage = ogImage.startsWith('http') ? ogImage : `${baseUrl}${ogImage}`;
const gaMeasurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID ?? '';
const botpressInjectUrl = import.meta.env.PUBLIC_BOTPRESS_INJECT_URL ?? 'https://cdn.botpress.cloud/webchat/v3.3/inject.js';
const botpressConfigUrl = import.meta.env.PUBLIC_BOTPRESS_CONFIG_URL ?? '';
const botpressBotId = import.meta.env.PUBLIC_BOTPRESS_BOT_ID ?? '';
const botpressClientId = import.meta.env.PUBLIC_BOTPRESS_CLIENT_ID ?? '';

function slugToName(segment: string) {
  return segment
    .split('-')
    .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
    .join(' ');
}

function buildDefaultBreadcrumbs(pathname: string) {
  const segments = pathname.split('/').filter(Boolean);
  let cumulativePath = '';
  return segments.map((segment) => {
    cumulativePath += `/${segment}`;
    return { name: slugToName(segment), href: cumulativePath };
  });
}

const resolvedBreadcrumbs = breadcrumbs && breadcrumbs.length > 0
  ? breadcrumbs
  : buildDefaultBreadcrumbs(currentPath);
const breadcrumbsWithHome = [{ name: 'Home', href: '/' }, ...resolvedBreadcrumbs];
const breadcrumbSchema = shouldShowBreadcrumbs
  ? {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": breadcrumbsWithHome.map((item, index) => ({
        "@type": "ListItem",
        "position": index + 1,
        "name": item.name,
        "item": `${baseUrl}${item.href ?? currentPath}`
      }))
    }
  : null;

// Default Organization structured data
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "name": "Lead Flow North",
  "description": "Web design and digital marketing agency specializing in lead generation for small businesses in Ontario and Alberta, Canada.",
  "url": "https://leadflownorth.com",
  "logo": "https://leadflownorth.com/logos/lfn-light-200.png",
  "telephone": "+1-905-783-5996",
  "email": "hello@leadflownorth.com",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "100 King Street West",
    "addressLocality": "Toronto",
    "addressRegion": "ON",
    "postalCode": "M5X 1A9",
    "addressCountry": "CA"
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": "43.6532",
    "longitude": "-79.3832"
  },
  "areaServed": [
    {
      "@type": "State",
      "name": "Ontario"
    },
    {
      "@type": "State", 
      "name": "Alberta"
    }
  ],
  "priceRange": "$$",
  "openingHours": "Mo-Fr 09:00-17:00",
  "sameAs": [
    "https://www.linkedin.com/company/leadflownorth",
    "https://twitter.com/leadflownorth",
    "https://www.facebook.com/leadflownorth"
  ]
};

const isEmbedLikeRoute =
  currentPath.startsWith('/demos') ||
  currentPath.startsWith('/samples') ||
  currentPath === '/book-call/' ||
  currentPath === '/thank-you/';
const shouldLoadBotpressChat =
  (!!botpressConfigUrl || (!!botpressBotId && !!botpressClientId)) &&
  !noIndex &&
  !isEmbedLikeRoute;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- Primary Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={description} />
    {noIndex && <meta name="robots" content="noindex, nofollow" />}
    
    <!-- Canonical URL -->
    <link rel="canonical" href={resolvedCanonicalURL} />
    
    <!-- Hreflang Tags for Canadian English -->
    <link rel="alternate" hreflang="en-CA" href={`${baseUrl}${currentPath}`} />
    <link rel="alternate" hreflang="en" href={`${baseUrl}${currentPath}`} />
    <link rel="alternate" hreflang="x-default" href={`${baseUrl}${currentPath}`} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={resolvedCanonicalURL} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={resolvedOgImage} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:locale" content="en_CA" />
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={resolvedCanonicalURL} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={resolvedOgImage} />
    <meta name="twitter:site" content="@leadflownorth" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#3b82f6" />
    
    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="Lead Flow North Blog" href="/rss.xml" />
    
    <!-- DNS Prefetch for external resources -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" media="print" onload="this.onload=null;this.setAttribute('media','all')" />
    <noscript>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" />
    </noscript>
    
    <!-- Structured Data -->
    <script is:inline type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
    {breadcrumbSchema && (
      <script is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
    )}
    {structuredData && (
      <script is:inline type="application/ld+json" set:html={JSON.stringify(structuredData)} />
    )}
    
    <!-- Dark mode script - runs before page render to prevent flash -->
    <script is:inline>
      (function() {
        const theme = localStorage.getItem('theme');
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
    
    <!-- Google tag (gtag.js) -->
    {gaMeasurementId && (
      <script is:inline define:vars={{ gaMeasurementId }}>
        const initAnalytics = () => {
          const script = document.createElement('script');
          script.async = true;
          script.src = `https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`;
          document.head.appendChild(script);
          window.dataLayer = window.dataLayer || [];
          window.gtag = window.gtag || function() { window.dataLayer.push(arguments); };
          window.gtag('js', new Date());
          window.gtag('config', gaMeasurementId);
        };

        if ('requestIdleCallback' in window) {
          requestIdleCallback(initAnalytics, { timeout: 1500 });
        } else {
          setTimeout(initAnalytics, 600);
        }
      </script>
    )}

    {shouldLoadBotpressChat && (
      <script is:inline define:vars={{ botpressInjectUrl, botpressConfigUrl, botpressBotId, botpressClientId }}>
        (function () {
          var loaded = false;
          var listenersBound = false;
          var fallbackTimer = null;
          function loadBotpress() {
            if (loaded) return;
            loaded = true;
            if (fallbackTimer) {
              clearTimeout(fallbackTimer);
              fallbackTimer = null;
            }
            if (listenersBound) {
              listenersBound = false;
              ['click', 'keydown', 'touchstart'].forEach(function(evt) {
                window.removeEventListener(evt, loadBotpress, true);
              });
            }

            var injectScript = document.createElement('script');
            injectScript.src = botpressInjectUrl;
            injectScript.async = true;
            injectScript.defer = true;
            injectScript.onload = function () {
              if (botpressConfigUrl) {
                var configScript = document.createElement('script');
                configScript.src = botpressConfigUrl;
                configScript.defer = true;
                document.head.appendChild(configScript);
                return;
              }

              if (window.botpress && botpressBotId && botpressClientId) {
                window.botpress.init({
                  botId: botpressBotId,
                  clientId: botpressClientId
                });
              }
            };
            document.head.appendChild(injectScript);
          }

          listenersBound = true;
          ['click', 'keydown', 'touchstart'].forEach(function(evt) {
            window.addEventListener(evt, loadBotpress, { once: true, passive: true, capture: true });
          });
          fallbackTimer = window.setTimeout(loadBotpress, 5000);
        })();
      </script>
    )}
  </head>
  <body class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 font-['Inter',sans-serif] antialiased transition-colors duration-300 pb-20 md:pb-0">
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <Header />
    
    {shouldShowBreadcrumbs && <Breadcrumbs items={breadcrumbs} />}
    
    <main id="main-content" role="main">
      <slot />
    </main>

    <!-- Mobile sticky CTA bar -->
    <div id="mobile-sticky-cta" class="fixed inset-x-0 bottom-0 z-50 border-t border-slate-200 dark:border-slate-700 bg-white/95 dark:bg-slate-900/95 backdrop-blur md:hidden">
      <div class="mx-auto flex max-w-7xl gap-2 px-3 py-3">
        <a
          href="/book-call"
          data-analytics="mobile_sticky_book_call"
          class="flex-1 inline-flex items-center justify-center rounded-lg bg-accent-700 px-4 py-3 text-sm font-semibold text-white hover:bg-accent-800 transition-colors"
        >
          Book Call
        </a>
        <a
          href="tel:+19057835996"
          data-analytics="mobile_sticky_call_now"
          class="flex-1 inline-flex items-center justify-center rounded-lg border border-slate-300 dark:border-slate-600 px-4 py-3 text-sm font-semibold text-slate-900 dark:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
        >
          Call Now
        </a>
      </div>
    </div>
    
    <Footer />
    
    <!-- Minimal JS for reveal animations on scroll - deferred for performance -->
    <script>
      // Use requestIdleCallback for non-critical initialization
      const initRevealAnimations = () => {
        const observerOptions = {
          root: null,
          rootMargin: '50px', // Start animation slightly before element is visible
          threshold: 0.1
        };
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              // Use requestAnimationFrame for smooth animation start
              requestAnimationFrame(() => {
                entry.target.classList.add('visible');
              });
              observer.unobserve(entry.target);
            }
          });
        }, observerOptions);
        
        document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
      };
      
      // Initialize after page is interactive
      if ('requestIdleCallback' in window) {
        requestIdleCallback(initRevealAnimations, { timeout: 200 });
      } else {
        setTimeout(initRevealAnimations, 100);
      }
    </script>
    <script is:inline define:vars={{ gaMeasurementId }}>
      window.trackLeadFlowEvent = function(eventName, params) {
        if (!eventName) return;
        if (typeof window.gtag === 'function' && gaMeasurementId) {
          window.gtag('event', eventName, params || {});
          return;
        }
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({ event: eventName, ...(params || {}) });
      };

      document.addEventListener('click', function(e) {
        var target = e.target && e.target.closest ? e.target.closest('[data-analytics]') : null;
        if (!target) return;
        var eventName = target.getAttribute('data-analytics');
        if (!eventName) return;
        var href = target.getAttribute('href') || '';
        window.trackLeadFlowEvent(eventName, {
          link_target: href,
          page_path: window.location.pathname
        });
      });

      var scrollTracked = false;
      window.addEventListener('scroll', function() {
        if (scrollTracked) return;
        var documentHeight = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
        var viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        var scrolled = window.scrollY + viewportHeight;
        if (documentHeight > 0 && (scrolled / documentHeight) >= 0.5) {
          scrollTracked = true;
          window.trackLeadFlowEvent('scroll_depth_50', { page_path: window.location.pathname });
        }
      }, { passive: true });
    </script>
    <script is:inline>
      (function() {
        if (window.location.pathname !== '/') return;
        var html = document.documentElement;
        var expKey = 'lfn_exp_home_hero';
        var params = new URLSearchParams(window.location.search);
        var forced = params.get('exp');
        var current = null;
        if (forced === 'a' || forced === 'b') {
          current = forced;
          localStorage.setItem(expKey, current);
        } else {
          current = localStorage.getItem(expKey);
          if (current !== 'a' && current !== 'b') {
            current = Math.random() < 0.5 ? 'a' : 'b';
            localStorage.setItem(expKey, current);
          }
        }

        html.dataset.experimentHero = current;
        var expElements = document.querySelectorAll('[data-exp-key="home-hero"]');
        expElements.forEach(function(el) {
          var value = current === 'b' ? el.getAttribute('data-exp-b') : el.getAttribute('data-exp-a');
          if (value) el.textContent = value;
        });
        if (window.trackLeadFlowEvent) {
          window.trackLeadFlowEvent('exp_home_hero_assigned', { variant: current, page_path: window.location.pathname });
        }
      })();
    </script>
    <script is:inline>
      (function() {
        if (!('PerformanceObserver' in window) || !window.trackLeadFlowEvent) return;
        var clsScore = 0;
        var lcpValue = 0;
        var inpValue = 0;
        var hidden = false;

        var sendVitals = function() {
          if (hidden) return;
          hidden = true;
          window.trackLeadFlowEvent('web_vitals', {
            page_path: window.location.pathname,
            cls: Number(clsScore.toFixed(4)),
            lcp_ms: Math.round(lcpValue),
            inp_ms: Math.round(inpValue)
          });
        };

        try {
          var clsObserver = new PerformanceObserver(function(list) {
            list.getEntries().forEach(function(entry) {
              if (!entry.hadRecentInput) clsScore += entry.value;
            });
          });
          clsObserver.observe({ type: 'layout-shift', buffered: true });

          var lcpObserver = new PerformanceObserver(function(list) {
            var entries = list.getEntries();
            var last = entries[entries.length - 1];
            if (last) lcpValue = last.startTime;
          });
          lcpObserver.observe({ type: 'largest-contentful-paint', buffered: true });

          var inpObserver = new PerformanceObserver(function(list) {
            list.getEntries().forEach(function(entry) {
              if (entry.duration > inpValue) inpValue = entry.duration;
            });
          });
          inpObserver.observe({ type: 'event', buffered: true, durationThreshold: 40 });

          document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') sendVitals();
          }, { once: true });
          window.addEventListener('pagehide', sendVitals, { once: true });
        } catch (_error) {
          // Ignore unsupported observers.
        }
      })();
    </script>
    <script is:inline>
      (function() {
        var sticky = document.getElementById('mobile-sticky-cta');
        if (!sticky) return;
        var hiddenPaths = ['/thank-you', '/privacy', '/terms'];
        var path = window.location.pathname.toLowerCase();
        var shouldHide = hiddenPaths.some(function(p) { return path === p || path.startsWith(p + '/'); });
        if (shouldHide || document.body.hasAttribute('data-hide-sticky-cta')) {
          sticky.classList.add('hidden');
          return;
        }

        var updateOffset = function() {
          var cookieBanner = document.querySelector('#cookie-consent, .cookie-banner, [data-cookie-banner]');
          if (!cookieBanner) {
            sticky.style.bottom = '0px';
            return;
          }
          var styles = window.getComputedStyle(cookieBanner);
          var hidden = styles.display === 'none' || styles.visibility === 'hidden' || cookieBanner.getAttribute('aria-hidden') === 'true';
          if (hidden) {
            sticky.style.bottom = '0px';
            return;
          }
          sticky.style.bottom = cookieBanner.offsetHeight + 'px';
        };

        updateOffset();
        window.addEventListener('resize', updateOffset);
        setTimeout(updateOffset, 800);
      })();
    </script>
  </body>
</html>
