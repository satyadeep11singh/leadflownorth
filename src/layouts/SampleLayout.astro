---
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  themeColor?: string;
  noIndex?: boolean;
}

const {
  title,
  description = '',
  themeColor = '#3b82f6',
  noIndex = false,
} = Astro.props;

const baseUrl = 'https://leadflownorth.com';
const currentPath = Astro.url.pathname;
const gaMeasurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID ?? '';
const botpressInjectUrl = import.meta.env.PUBLIC_BOTPRESS_INJECT_URL ?? 'https://cdn.botpress.cloud/webchat/v3.3/inject.js';
const botpressConfigUrl = import.meta.env.PUBLIC_BOTPRESS_CONFIG_URL ?? '';
const botpressBotId = import.meta.env.PUBLIC_BOTPRESS_BOT_ID ?? '7e372dd7-b45a-402b-be86-be2c17425e95';
const botpressClientId = import.meta.env.PUBLIC_BOTPRESS_CLIENT_ID ?? '05c0d922-5da1-4c4a-93d5-9319c2a2cd48';
const shouldLoadBotpressChat =
  !!botpressConfigUrl || (!!botpressBotId && !!botpressClientId);
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>{title}</title>
    <meta name="description" content={description} />
    {noIndex && <meta name="robots" content="noindex, nofollow" />}
    <link rel="canonical" href={`${baseUrl}${currentPath}`} />

    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />

    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
    <meta name="theme-color" content={themeColor} />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" media="print" onload="this.onload=null;this.setAttribute('media','all')" />
    <noscript>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" />
    </noscript>

    {gaMeasurementId && (
      <script is:inline define:vars={{ gaMeasurementId }}>
        const initAnalytics = () => {
          const script = document.createElement('script');
          script.async = true;
          script.src = `https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`;
          document.head.appendChild(script);
          window.dataLayer = window.dataLayer || [];
          window.gtag = window.gtag || function() { window.dataLayer.push(arguments); };
          window.gtag('js', new Date());
          window.gtag('config', gaMeasurementId);
        };

        if ('requestIdleCallback' in window) {
          requestIdleCallback(initAnalytics, { timeout: 1500 });
        } else {
          setTimeout(initAnalytics, 600);
        }
      </script>
    )}

    {shouldLoadBotpressChat && (
      <script is:inline define:vars={{ botpressInjectUrl, botpressConfigUrl, botpressBotId, botpressClientId }}>
        (function () {
          var loaded = false;
          var quickActionsMounted = false;

          function pinLauncherBottomRight() {
            if (document.getElementById('lfn-botpress-position')) return;
            var style = document.createElement('style');
            style.id = 'lfn-botpress-position';
            style.textContent = [
              '.bpFab{display:flex!important;position:fixed!important;right:20px!important;bottom:20px!important;z-index:9999!important}',
              '#lfn-bp-quick-actions{position:fixed;right:20px;bottom:92px;z-index:9998;display:flex;flex-direction:column;gap:8px;align-items:flex-end;max-width:min(92vw,340px)}',
              '#lfn-bp-quick-actions.hidden{display:none!important}',
              '#lfn-bp-quick-actions .lfn-quick-btn{background:#fff;border:1px solid rgba(15,23,42,.16);color:#0f172a;border-radius:9999px;padding:9px 12px;font-size:12px;font-weight:600;line-height:1.2;box-shadow:0 6px 16px rgba(2,6,23,.15);cursor:pointer;max-width:100%;text-align:left}',
              '#lfn-bp-quick-actions .lfn-quick-btn:hover{background:#f8fafc}',
              '@media (max-width: 640px){#lfn-bp-quick-actions{right:12px;bottom:106px;max-width:calc(100vw - 24px)}#lfn-bp-quick-actions .lfn-quick-btn{font-size:11px;padding:8px 10px}}'
            ].join('');
            document.head.appendChild(style);
          }

          function mountQuickActions() {
            if (quickActionsMounted || document.getElementById('lfn-bp-quick-actions')) return;
            if (!window.botpress || typeof window.botpress.sendMessage !== 'function') return;
            if (!document.body) return;

            var prompts = [
              { label: 'Industries you serve', message: 'Which industries do you serve? Please share clickable links.' },
              { label: 'Free website audit', message: 'I want a free website and SEO audit. I already have a website.' },
              { label: 'ROI calculator', message: 'Show me the ROI calculator and how to use it for my business.' },
              { label: 'Book discovery call', message: 'I am interested. Why is a discovery call the best next step?' }
            ];

            var container = document.createElement('div');
            container.id = 'lfn-bp-quick-actions';

            prompts.forEach(function(item) {
              var btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'lfn-quick-btn';
              btn.textContent = item.label;
              btn.addEventListener('click', function() {
                if (window.botpress && typeof window.botpress.open === 'function') {
                  window.botpress.open();
                }
                if (window.botpress && typeof window.botpress.sendMessage === 'function') {
                  window.botpress.sendMessage(item.message);
                }
              });
              container.appendChild(btn);
            });

            document.body.appendChild(container);
            quickActionsMounted = true;
          }

          function waitForBotpressApi(retries) {
            if (window.botpress && typeof window.botpress.sendMessage === 'function') {
              mountQuickActions();
              return;
            }
            if (retries <= 0) return;
            setTimeout(function() { waitForBotpressApi(retries - 1); }, 250);
          }

          function initQuickActions() {
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', function() {
                waitForBotpressApi(50);
              }, { once: true });
              return;
            }
            waitForBotpressApi(50);
          }

          function loadBotpress() {
            if (loaded) return;
            loaded = true;
            var injectScript = document.createElement('script');
            injectScript.src = botpressInjectUrl;
            injectScript.async = true;
            injectScript.defer = true;
            injectScript.onload = function () {
              if (botpressConfigUrl) {
                var configScript = document.createElement('script');
                configScript.src = botpressConfigUrl;
                configScript.defer = true;
                configScript.onload = function () {
                  pinLauncherBottomRight();
                  initQuickActions();
                };
                document.head.appendChild(configScript);
                return;
              }

              if (window.botpress && botpressBotId && botpressClientId) {
                window.botpress.init({
                  botId: botpressBotId,
                  clientId: botpressClientId
                });
                pinLauncherBottomRight();
                initQuickActions();
              }
            };
            document.head.appendChild(injectScript);
          }

          loadBotpress();
        })();
      </script>
    )}
  </head>
  <body class="bg-white text-slate-800 font-['Inter',sans-serif] antialiased">
    <slot />
  </body>
</html>
