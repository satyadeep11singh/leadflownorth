---
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  themeColor?: string;
  noIndex?: boolean;
}

const {
  title,
  description = '',
  themeColor = '#3b82f6',
  noIndex = false,
} = Astro.props;

const baseUrl = 'https://leadflownorth.com';
const currentPath = Astro.url.pathname;
const gaMeasurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID ?? '';
const botpressInjectUrl = import.meta.env.PUBLIC_BOTPRESS_INJECT_URL ?? 'https://cdn.botpress.cloud/webchat/v3.3/inject.js';
const botpressConfigUrl = import.meta.env.PUBLIC_BOTPRESS_CONFIG_URL ?? '';
const botpressBotId = import.meta.env.PUBLIC_BOTPRESS_BOT_ID ?? '7e372dd7-b45a-402b-be86-be2c17425e95';
const botpressClientId = import.meta.env.PUBLIC_BOTPRESS_CLIENT_ID ?? '05c0d922-5da1-4c4a-93d5-9319c2a2cd48';
const shouldLoadBotpressChat =
  !!botpressConfigUrl || (!!botpressBotId && !!botpressClientId);
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>{title}</title>
    <meta name="description" content={description} />
    {noIndex && <meta name="robots" content="noindex, nofollow" />}
    <link rel="canonical" href={`${baseUrl}${currentPath}`} />

    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />

    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
    <meta name="theme-color" content={themeColor} />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" media="print" onload="this.onload=null;this.setAttribute('media','all')" />
    <noscript>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" />
    </noscript>

    {gaMeasurementId && (
      <script is:inline define:vars={{ gaMeasurementId }}>
        const initAnalytics = () => {
          const script = document.createElement('script');
          script.async = true;
          script.src = `https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`;
          document.head.appendChild(script);
          window.dataLayer = window.dataLayer || [];
          window.gtag = window.gtag || function() { window.dataLayer.push(arguments); };
          window.gtag('js', new Date());
          window.gtag('config', gaMeasurementId);
        };

        if ('requestIdleCallback' in window) {
          requestIdleCallback(initAnalytics, { timeout: 1500 });
        } else {
          setTimeout(initAnalytics, 600);
        }
      </script>
    )}

    {shouldLoadBotpressChat && (
      <script is:inline define:vars={{ botpressInjectUrl, botpressConfigUrl, botpressBotId, botpressClientId }}>
        (function () {
          var loaded = false;
          var contextSent = false;
          var listenersBound = false;
          var exitIntentWatcherBound = false;
          var EXIT_HOOK_STORAGE_KEY = 'lfn_bp_exit_intent_hook_shown';
          var CONVERSATION_STORAGE_KEY = 'lfn_bp_conversation_started';
          var EXIT_HOOK_MESSAGE = "Before you head out, want a quick win first? I can help you run a Free Website & SEO Audit (if you already have a site) or a fast ROI Calculator check to see if we're worth it before you commit.";
          var conversationStarted = readSessionFlag(CONVERSATION_STORAGE_KEY);
          var exitHookShown = readSessionFlag(EXIT_HOOK_STORAGE_KEY);

          function readSessionFlag(key) {
            try {
              return window.sessionStorage.getItem(key) === '1';
            } catch (_error) {
              return false;
            }
          }

          function writeSessionFlag(key) {
            try {
              window.sessionStorage.setItem(key, '1');
            } catch (_error) {
              // Ignore storage errors (private mode / disabled storage).
            }
          }

          function markConversationStarted() {
            if (conversationStarted) {
              return;
            }
            conversationStarted = true;
            writeSessionFlag(CONVERSATION_STORAGE_KEY);
          }

          function bindRuntimeListeners() {
            if (listenersBound || !window.botpress || typeof window.botpress.on !== 'function') {
              return;
            }
            listenersBound = true;
            window.botpress.on('message', function () {
              markConversationStarted();
            });
            window.botpress.on('conversation', function () {
              markConversationStarted();
            });
          }

          function getPageContext() {
            var path = (window.location.pathname || '/').toLowerCase();
            var context = {
              path: path,
              pageType: 'general',
              pageCue: "Let's find your true North."
            };

            if (path.indexOf('/services') === 0 || path.indexOf('/pricing') === 0) {
              context.pageType = 'pricing_or_services';
              context.pageCue = 'Ready to scale? I can show you which path yields the highest ROI.';
              return context;
            }

            if (path.indexOf('/roi-calculator') === 0) {
              context.pageType = 'roi_calculator';
              context.pageCue = 'Want a fast estimate first? I can walk you through the ROI calculator.';
              return context;
            }

            if (path.indexOf('/free-audit') === 0) {
              context.pageType = 'free_audit';
              context.pageCue = 'If you already have a website, I can point you to the free audit in under a minute.';
              return context;
            }

            if (path.indexOf('/contact') === 0 || path.indexOf('/book-call') === 0) {
              context.pageType = 'contact_or_booking';
              context.pageCue = 'If you are ready, I can help you book the discovery call.';
            }

            return context;
          }

          function triggerExitIntentHook(pageContext) {
            if (conversationStarted || exitHookShown || !window.botpress) {
              return;
            }

            exitHookShown = true;
            writeSessionFlag(EXIT_HOOK_STORAGE_KEY);

            var exitCue = 'Visitor showed exit intent. Start with the exit-intent sales hook.';
            if (typeof window.botpress.updateUser === 'function') {
              window.botpress.updateUser({
                data: {
                  page_path: pageContext.path,
                  page_type: pageContext.pageType,
                  page_cue: exitCue,
                  exit_intent: true,
                  exit_intent_hook: EXIT_HOOK_MESSAGE
                }
              }).catch(function () {});
            }

            if (typeof window.botpress.sendEvent === 'function') {
              window.botpress.sendEvent({
                type: 'lfn.exit_intent',
                payload: {
                  path: pageContext.path,
                  pageType: pageContext.pageType,
                  hookMessage: EXIT_HOOK_MESSAGE
                }
              }).catch(function () {});
            }

            if (typeof window.botpress.open === 'function') {
              window.botpress.open();
            }
          }

          function setupExitIntentWatcher(pageContext) {
            if (exitIntentWatcherBound || conversationStarted || exitHookShown) {
              return;
            }
            if (window.matchMedia && !window.matchMedia('(pointer:fine)').matches) {
              return;
            }

            exitIntentWatcherBound = true;
            var exitContext = {
              path: pageContext.path,
              pageType: pageContext.pageType,
              pageCue: pageContext.pageCue
            };

            document.addEventListener('mouseout', function (event) {
              if (conversationStarted || exitHookShown) {
                return;
              }
              var related = event.relatedTarget || event.toElement;
              if (related) {
                return;
              }
              if (typeof event.clientY !== 'number' || event.clientY > 0) {
                return;
              }
              triggerExitIntentHook(exitContext);
            }, { passive: true });
          }

          function buildNoraConfiguration() {
            var origin = window.location.origin || 'https://leadflownorth.com';
            return {
              botName: 'Nora',
              botDescription: 'Lead Flow North AI assistant',
              composerPlaceholder: 'Which direction are we heading today?',
              color: '#2563eb',
              variant: 'solid',
              themeMode: 'light',
              radius: 2,
              fontFamily: 'inter',
              botAvatar: origin + '/icon-192.png',
              fabImage: origin + '/icon-192.png',
              website: {
                title: 'leadflownorth.com',
                link: 'https://leadflownorth.com'
              },
              email: {
                title: 'hello@leadflownorth.com',
                link: 'mailto:hello@leadflownorth.com'
              },
              phone: {
                title: '+1 (905) 783-5996',
                link: 'tel:+19057835996'
              },
              termsOfService: {
                title: 'Terms',
                link: 'https://leadflownorth.com/terms'
              },
              privacyPolicy: {
                title: 'Privacy',
                link: 'https://leadflownorth.com/privacy'
              },
              additionalStylesheet: [
                '.bpFab{display:flex!important;position:fixed!important;right:20px!important;bottom:20px!important;z-index:9999!important;box-shadow:0 14px 36px rgba(15,23,42,.32)!important}',
                '.bpHeaderContainer{background:linear-gradient(135deg,#0f172a 0%,#1d4ed8 58%,#16a34a 100%)!important}',
                '.bpComposerSendButton{background:#15803d!important;color:#fff!important}',
                '.bpComposerSendButton:hover{background:#166534!important}',
                '.bpMessageBlocksButton,.bpMessageBlocksButton button{border-radius:9999px!important;font-weight:600!important}',
                '@media (max-width: 767px){.bpFab{right:16px!important;bottom:88px!important}}'
              ].join('')
            };
          }

          function applyPageContext(pageContext) {
            if (!window.botpress) return;

            if (typeof window.botpress.updateUser === 'function') {
              window.botpress.updateUser({
                data: {
                  page_path: pageContext.path,
                  page_type: pageContext.pageType,
                  page_cue: pageContext.pageCue
                }
              }).catch(function () {});
            }

            if (!contextSent && typeof window.botpress.sendEvent === 'function') {
              contextSent = true;
              window.botpress.sendEvent({
                type: 'lfn.page_context',
                payload: {
                  path: pageContext.path,
                  pageType: pageContext.pageType,
                  pageCue: pageContext.pageCue
                }
              }).catch(function () {});
            }
          }

          function initWithCredentials(pageContext) {
            if (!window.botpress || !botpressBotId || !botpressClientId) {
              return false;
            }

            window.botpress.init({
              botId: botpressBotId,
              clientId: botpressClientId,
              configuration: buildNoraConfiguration()
            });

            bindRuntimeListeners();
            applyPageContext(pageContext);
            setupExitIntentWatcher(pageContext);
            return true;
          }

          function loadBotpress() {
            if (loaded) return;
            loaded = true;
            var pageContext = getPageContext();
            var injectScript = document.createElement('script');
            injectScript.src = botpressInjectUrl;
            injectScript.async = true;
            injectScript.defer = true;
            injectScript.onload = function () {
              if (initWithCredentials(pageContext)) {
                return;
              }

              if (botpressConfigUrl) {
                var configScript = document.createElement('script');
                configScript.src = botpressConfigUrl;
                configScript.defer = true;
                configScript.onload = function () {
                  if (window.botpress && typeof window.botpress.config === 'function') {
                    window.botpress.config({
                      configuration: buildNoraConfiguration()
                    });
                  }
                  bindRuntimeListeners();
                  applyPageContext(pageContext);
                  setupExitIntentWatcher(pageContext);
                };
                document.head.appendChild(configScript);
                return;
              }

              if (window.botpress && typeof window.botpress.config === 'function') {
                window.botpress.config({
                  configuration: buildNoraConfiguration()
                });
                bindRuntimeListeners();
                applyPageContext(pageContext);
                setupExitIntentWatcher(pageContext);
              }
            };
            document.head.appendChild(injectScript);
          }

          loadBotpress();
        })();
      </script>
    )}
  </head>
  <body class="bg-white text-slate-800 font-['Inter',sans-serif] antialiased">
    <slot />
  </body>
</html>
