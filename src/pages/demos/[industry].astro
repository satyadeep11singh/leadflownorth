---
import Layout from '../../layouts/Layout.astro';
import DemoForm from '../../components/DemoForm.astro';
import DemoPreview from '../../components/DemoPreview.astro';
import { demoIndustries, type IndustryDemo } from '../../data/demo-industries';

export function getStaticPaths() {
  return demoIndustries.map((ind) => ({
    params: { industry: ind.slug },
    props: { industry: ind },
  }));
}

interface Props {
  industry: IndustryDemo;
}

const { industry } = Astro.props;

const schema = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": `${industry.name} Website Demo Builder — Lead Flow North`,
  "description": `See what your ${industry.name.toLowerCase()} website could look like. Enter your business details and watch a custom website preview come to life.`,
  "provider": {
    "@type": "LocalBusiness",
    "name": "Lead Flow North"
  },
  "applicationCategory": "DesignApplication",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "CAD"
  }
};
---

<Layout
  title={`${industry.name} Website Demo — See Your Custom Website | Lead Flow North`}
  description={`Enter your business details and see a live preview of your custom ${industry.name.toLowerCase()} website. Free interactive demo builder by Lead Flow North.`}
  structuredData={schema}
>
  <!-- Hero Banner -->
  <section class="py-8 lg:py-12 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800">
    <div class="w-full px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <a href="/demos" class="inline-flex items-center gap-1 text-sm text-primary-600 dark:text-primary-400 hover:text-primary-700 mb-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            All Demos
          </a>
          <h1 class="text-2xl sm:text-3xl font-extrabold text-slate-900 dark:text-white">
            <span class="mr-2">{industry.icon}</span> {industry.name} Website Demo
          </h1>
          <p class="text-slate-600 dark:text-slate-300 mt-1">{industry.description}</p>
        </div>
        <div class="flex items-center gap-3">
          <a href={industry.industryPageHref} class="text-sm text-slate-500 dark:text-slate-400 hover:text-primary-600 transition-colors">
            Learn more about our {industry.name.toLowerCase()} services &rarr;
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Mobile Form Toggle -->
  <div class="lg:hidden sticky top-16 z-30 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 px-4 py-3">
    <button
      id="demo-form-toggle"
      class="w-full flex items-center justify-between px-4 py-2.5 bg-primary-50 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 rounded-xl font-medium text-sm"
      aria-expanded="false"
      aria-controls="demo-form-wrapper"
    >
      <span class="flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
        Customize Your Website
      </span>
      <svg id="demo-form-toggle-icon" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
    </button>
  </div>

  <!-- Main Content: Form + Preview -->
  <section class="py-6 lg:py-10 bg-slate-50 dark:bg-slate-900/50">
    <div class="w-full px-4 sm:px-6 lg:px-8">
      <div id="demo-layout" class="grid lg:grid-cols-[380px_1fr] gap-6 lg:gap-8 items-stretch transition-all duration-300">
        <!-- Left: Customization Form (hidden on mobile by default, always visible on desktop) -->
        <div class="hidden lg:block transition-all duration-300 overflow-hidden" id="demo-form-wrapper">
          <DemoForm
            defaults={industry.defaults}
            services={industry.services}
            industryName={industry.name}
          />
        </div>

        <!-- Right: Live Preview -->
        <div class="flex flex-col">
          <!-- Device Preview Toolbar (desktop only) -->
          <div class="hidden lg:flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <!-- Sidebar Toggle Button -->
              <button
                id="sidebar-toggle"
                class="flex items-center gap-2 px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                title="Toggle customization panel"
              >
                <svg id="sidebar-toggle-icon" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                </svg>
                <span id="sidebar-toggle-text">Hide Panel</span>
              </button>
            </div>

            <!-- Device Switcher -->
            <div class="flex items-center bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-1 gap-1">
              <button
                data-device="mobile"
                class="device-btn flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                title="Phone preview (375px)"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                Phone
              </button>
              <button
                data-device="tablet"
                class="device-btn flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                title="Tablet preview (768px)"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                iPad
              </button>
              <button
                data-device="desktop"
                class="device-btn device-btn-active flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 transition-colors"
                title="Desktop preview (full width)"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                Desktop
              </button>
            </div>
          </div>

          <!-- Preview Container (centers the preview at constrained widths) -->
          <div id="demo-preview-frame" class="flex justify-center flex-1">
            <div id="demo-preview-sizer" class="w-full transition-all duration-300">
              <DemoPreview industry={industry} />
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Bottom CTA -->
  <section class="py-16 lg:py-24 bg-gradient-to-br from-primary-600 to-primary-800">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl sm:text-4xl font-bold text-white mb-4">
        Love What You See?
      </h2>
      <p class="text-lg text-primary-100 mb-8 max-w-2xl mx-auto">
        This is just a preview. Your actual website will be custom-designed, fully responsive, and optimized to convert visitors into customers. Let's make it real.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="/contact" class="inline-flex items-center justify-center px-8 py-4 bg-white text-primary-700 font-bold text-lg rounded-xl hover:bg-primary-50 transition-colors duration-200 shadow-xl">
          Book Your Free Strategy Call
          <svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
        </a>
        <a href={`/roi-calculator?industry=${industry.roiPreset}`} class="inline-flex items-center justify-center px-8 py-4 border-2 border-white/50 text-white font-bold text-lg rounded-xl hover:bg-white/10 transition-colors duration-200">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
          Calculate Your ROI
        </a>
      </div>
      <p class="mt-6 text-sm text-primary-200">
        Founding client pricing: websites from $999 &bull; No contracts &bull; 14-day delivery guarantee
      </p>
    </div>
  </section>
</Layout>

<script>
  // ══════════════════════════════════════════════════
  // LIVE PREVIEW ENGINE
  // Connects form inputs to preview DOM via data-demo attributes
  // ══════════════════════════════════════════════════

  const preview = document.getElementById('demo-preview');
  if (!preview) throw new Error('Preview container not found');

  // ─── Helper: update all elements matching a data-demo attribute ───
  function updateText(attr: string, value: string) {
    document.querySelectorAll(`[data-demo="${attr}"]`).forEach((el) => {
      el.textContent = value;
    });
  }

  // ─── Helper: lighten color for backgrounds ───
  function colorWithAlpha(hex: string, alpha: string): string {
    return hex + alpha;
  }

  // ─── TEXT FIELD BINDINGS ───
  const fieldMappings: Array<{ inputId: string; targets: string[]; transform?: (v: string) => string }> = [
    {
      inputId: 'demo-business-name',
      targets: ['nav-business-name', 'hero-business-name', 'about-business-name', 'footer-business-name', 'footer-copyright-name'],
    },
    {
      inputId: 'demo-business-name',
      targets: ['url-name'],
      transform: (v: string) => v.toLowerCase().replace(/[^a-z0-9]+/g, ''),
    },
    {
      inputId: 'demo-business-name',
      targets: ['logo-letter'],
      transform: (v: string) => v.charAt(0).toUpperCase(),
    },
    {
      inputId: 'demo-tagline',
      targets: ['hero-tagline'],
    },
    {
      inputId: 'demo-phone',
      targets: ['nav-phone', 'hero-phone', 'contact-phone', 'footer-phone'],
    },
    {
      inputId: 'demo-email',
      targets: ['contact-email', 'footer-email'],
    },
    {
      inputId: 'demo-location',
      targets: ['about-location', 'contact-location', 'footer-location', 'review-location-1', 'review-location-2'],
    },
  ];

  fieldMappings.forEach(({ inputId, targets, transform }) => {
    const input = document.getElementById(inputId) as HTMLInputElement | null;
    if (!input) return;

    // Deduplicate listeners for same inputId by grouping targets
    const handler = () => {
      const val = input.value || input.placeholder;
      const output = transform ? transform(val) : val;
      targets.forEach((t) => updateText(t, output));
    };

    // Only attach one listener per unique inputId
    if (!input.dataset.bound || !input.dataset.bound.includes(targets[0])) {
      input.addEventListener('input', handler);
      input.dataset.bound = (input.dataset.bound || '') + targets.join(',');
    }
  });

  // ─── COLOR BINDINGS ───
  const primaryColorInput = document.getElementById('demo-primary-color') as HTMLInputElement | null;
  const accentColorInput = document.getElementById('demo-accent-color') as HTMLInputElement | null;

  function updateColors() {
    if (primaryColorInput && preview) {
      preview.style.setProperty('--demo-primary', primaryColorInput.value);
      preview.style.setProperty('--demo-primary-light', primaryColorInput.value + '20');
    }
    if (accentColorInput && preview) {
      preview.style.setProperty('--demo-accent', accentColorInput.value);
    }
  }

  if (primaryColorInput) {
    primaryColorInput.addEventListener('input', updateColors);
    primaryColorInput.addEventListener('color-change', updateColors);
  }
  if (accentColorInput) {
    accentColorInput.addEventListener('input', updateColors);
    accentColorInput.addEventListener('color-change', updateColors);
  }

  // ─── SERVICE TOGGLE BINDINGS ───
  document.querySelectorAll('.service-checkbox').forEach((cb) => {
    cb.addEventListener('change', () => {
      const checkbox = cb as HTMLInputElement;
      const index = checkbox.dataset.index;
      const card = document.querySelector(`[data-service-index="${index}"]`) as HTMLElement | null;
      if (card) {
        if (checkbox.checked) {
          card.style.display = '';
          card.style.opacity = '1';
        } else {
          card.style.display = 'none';
        }
      }
    });
  });

  // ─── MOBILE FORM TOGGLE ───
  const formToggle = document.getElementById('demo-form-toggle');
  const formWrapper = document.getElementById('demo-form-wrapper');
  const toggleIcon = document.getElementById('demo-form-toggle-icon');

  if (formToggle && formWrapper) {
    formToggle.addEventListener('click', () => {
      const isCurrentlyHidden = formWrapper.classList.contains('hidden');

      if (isCurrentlyHidden) {
        // Show the form
        formWrapper.classList.remove('hidden');
        formWrapper.classList.add('block');
        formToggle.setAttribute('aria-expanded', 'true');
        if (toggleIcon) toggleIcon.style.transform = 'rotate(180deg)';
      } else {
        // Hide the form
        formWrapper.classList.remove('block');
        formWrapper.classList.add('hidden');
        formToggle.setAttribute('aria-expanded', 'false');
        if (toggleIcon) toggleIcon.style.transform = 'rotate(0deg)';
      }
    });
  }

  // ─── DESKTOP SIDEBAR TOGGLE ───
  const sidebarToggle = document.getElementById('sidebar-toggle');
  const sidebarToggleIcon = document.getElementById('sidebar-toggle-icon');
  const sidebarToggleText = document.getElementById('sidebar-toggle-text');
  const demoLayout = document.getElementById('demo-layout');

  if (sidebarToggle && formWrapper && demoLayout) {
    sidebarToggle.addEventListener('click', () => {
      const isVisible = !formWrapper.classList.contains('lg:hidden');

      if (isVisible) {
        // Collapse sidebar
        formWrapper.classList.add('lg:hidden');
        formWrapper.classList.remove('lg:block');
        demoLayout.style.gridTemplateColumns = '1fr';
        if (sidebarToggleIcon) sidebarToggleIcon.style.transform = 'rotate(180deg)';
        if (sidebarToggleText) sidebarToggleText.textContent = 'Show Panel';
      } else {
        // Expand sidebar
        formWrapper.classList.remove('lg:hidden');
        formWrapper.classList.add('lg:block');
        demoLayout.style.gridTemplateColumns = '380px 1fr';
        if (sidebarToggleIcon) sidebarToggleIcon.style.transform = 'rotate(0deg)';
        if (sidebarToggleText) sidebarToggleText.textContent = 'Hide Panel';
      }
    });
  }

  // ─── DEVICE PREVIEW SWITCHER ───
  const deviceBtns = document.querySelectorAll('.device-btn');
  const previewSizer = document.getElementById('demo-preview-sizer');

  const deviceWidths: Record<string, string> = {
    mobile: '375px',
    tablet: '768px',
    desktop: '100%',
  };

  deviceBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      const device = (btn as HTMLElement).dataset.device || 'desktop';

      // Update active state
      deviceBtns.forEach((b) => {
        b.classList.remove('device-btn-active', 'bg-primary-100', 'dark:bg-primary-900/30', 'text-primary-700', 'dark:text-primary-300');
        b.classList.add('text-slate-500', 'dark:text-slate-400');
      });
      btn.classList.add('device-btn-active', 'bg-primary-100', 'dark:bg-primary-900/30', 'text-primary-700', 'dark:text-primary-300');
      btn.classList.remove('text-slate-500', 'dark:text-slate-400');

      // Update preview width
      if (previewSizer) {
        if (device === 'desktop') {
          previewSizer.style.maxWidth = '';
          previewSizer.style.width = '100%';
        } else {
          previewSizer.style.maxWidth = deviceWidths[device];
          previewSizer.style.width = '100%';
        }
      }
    });
  });

  // ─── UPDATE CTA LINKS WITH BUSINESS INFO ───
  const bookCta = document.getElementById('demo-cta-book') as HTMLAnchorElement | null;
  const businessNameInput = document.getElementById('demo-business-name') as HTMLInputElement | null;

  if (bookCta && businessNameInput) {
    businessNameInput.addEventListener('input', () => {
      const name = encodeURIComponent(businessNameInput.value || '');
      const base = '/contact';
      bookCta.href = name ? `${base}?business=${name}` : base;
    });
  }
</script>
