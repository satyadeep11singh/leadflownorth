---
import Layout from '../layouts/Layout.astro';

// Get position from URL params (Astro.url is always available and includes query params)
const position = Astro.url.searchParams.get('position') || '';
const jobTitle = Astro.url.searchParams.get('title') || 'this position';

const applySchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Apply - Lead Flow North",
  "description": "Submit your application to join the Lead Flow North team.",
  "url": "https://leadflownorth.com/apply"
};
---

<Layout 
  title="Apply for {position || 'this position'}"
  description="Submit your application to join the Lead Flow North team. We're excited to hear from you!"
  structuredData={applySchema}
>
  <!-- Application Form -->
  <section class="py-16 lg:py-24 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="text-center mb-8">
        <a href="/careers" class="inline-flex items-center gap-2 text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 mb-6 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
          Back to Careers
        </a>
        <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900 dark:text-white mb-3">
          Apply for <span id="job-title-display" class="text-primary-600">this position</span>
        </h1>
        <p class="text-lg text-slate-600 dark:text-slate-400">
          Fill out the form below and we'll be in touch soon.
        </p>
      </div>

      <!-- Form Card -->
      <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 lg:p-8 border border-slate-200 dark:border-slate-700">
        <form action="https://api.web3forms.com/submit" method="POST" enctype="multipart/form-data" class="space-y-6">
          <!-- Hidden Fields -->
          <input type="hidden" name="access_key" value="1044dd8b-eacf-4d46-bd1a-261f931c40da">
          <input type="hidden" name="redirect" value="https://leadflownorth.com/thank-you">
          <input type="hidden" id="position-hidden" name="position" value="">
          <input type="hidden" id="subject-hidden" name="subject" value="">
          
          <!-- Position Display (Read-only) -->
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              Position
            </label>
            <input 
              type="text" 
              id="position-display"
              value="this position"
              disabled
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-slate-900/50 text-slate-900 dark:text-white font-medium cursor-not-allowed"
            >
          </div>

          <!-- Full Name -->
          <div>
            <label for="name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              Full Name <span class="text-red-500">*</span>
            </label>
            <input 
              type="text" 
              id="name" 
              name="name" 
              required
              autocomplete="name"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
              placeholder="John Smith"
            >
          </div>

          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              Email Address <span class="text-red-500">*</span>
            </label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              required
              autocomplete="email"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
              placeholder="john@example.com"
            >
          </div>

          <!-- Phone -->
          <div>
            <label for="phone" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              Phone Number <span class="text-red-500">*</span>
            </label>
            <input 
              type="tel" 
              id="phone" 
              name="phone" 
              required
              autocomplete="tel"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
              placeholder="(416) 555-0123"
            >
          </div>

          <!-- LinkedIn -->
          <div>
            <label for="linkedin" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              LinkedIn Profile <span class="text-slate-400 text-xs">(optional)</span>
            </label>
            <input 
              type="url" 
              id="linkedin" 
              name="linkedin"
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
              placeholder="https://linkedin.com/in/yourprofile"
            >
          </div>

          <!-- Resume Upload -->
          <div>
            <label for="resume" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              Resume <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <input 
                type="file" 
                id="resume" 
                name="resume" 
                required
                accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                class="hidden"
              >
              <label 
                for="resume" 
                id="resume-label"
                class="flex items-center justify-center gap-3 w-full px-4 py-8 rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800/50 cursor-pointer hover:border-primary-500 dark:hover:border-primary-500 transition-all duration-200"
              >
                <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <div class="text-center">
                  <span id="resume-text" class="block text-slate-700 dark:text-slate-300 font-medium">Click to upload or drag and drop</span>
                  <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">PDF or DOCX (max 5MB)</p>
                </div>
              </label>
            </div>
            <p id="file-error" class="hidden mt-2 text-sm text-red-500"></p>
          </div>

          <!-- Cover Letter -->
          <div>
            <label for="cover-letter" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              Cover Letter <span class="text-red-500">*</span>
            </label>
            <textarea 
              id="cover-letter" 
              name="cover-letter" 
              rows="6"
              required
              class="w-full px-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 resize-none"
              placeholder="Tell us why you're interested in this role and what makes you a great fit..."
            ></textarea>
          </div>

          <!-- Submit Button -->
          <button 
            type="submit"
            class="w-full py-4 px-6 bg-accent-500 hover:bg-accent-600 text-white font-bold text-lg rounded-xl transition-all duration-200 hover:shadow-lg hover:shadow-accent-500/25 flex items-center justify-center gap-2"
          >
            <span>Submit Application</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
            </svg>
          </button>

          <p class="text-xs text-slate-500 dark:text-slate-400 text-center">
            By submitting this form, you agree to our <a href="/privacy" class="underline hover:text-primary-600">Privacy Policy</a>.
          </p>
        </form>
      </div>

      <!-- Help Text -->
      <div class="mt-8 text-center">
        <p class="text-sm text-slate-600 dark:text-slate-400">
          Questions about the role? Email us at 
          <a href="mailto:careers@leadflownorth.com" class="text-primary-600 dark:text-primary-400 hover:underline font-medium">
            careers@leadflownorth.com
          </a>
        </p>
      </div>
    </div>
  </section>
</Layout>

<script>
  // Hydrate position and title from query params
  const params = new URLSearchParams(window.location.search);
  const position = params.get('position') || '';
  const jobTitle = params.get('title') || 'this position';
  document.getElementById('position-display').value = jobTitle;
  document.getElementById('job-title-display').textContent = jobTitle;
  document.getElementById('position-hidden').value = position;
  document.getElementById('subject-hidden').value = `Job Application: ${jobTitle}`;
  
  // File upload elements
  const resumeInput = document.getElementById('resume') as HTMLInputElement;
  const resumeLabel = document.getElementById('resume-label');
  const resumeText = document.getElementById('resume-text');
  const fileError = document.getElementById('file-error');
  
  // File validation
  const allowedTypes = [
    'application/pdf',
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
  ];
  const allowedExtensions = ['.pdf', '.doc', '.docx'];
  const maxSize = 5 * 1024 * 1024; // 5MB
  
  const validateFile = (file: File): boolean => {
    const extension = '.' + file.name.split('.').pop()?.toLowerCase();
    const isValidType = allowedTypes.includes(file.type) || allowedExtensions.includes(extension);
    const isValidSize = file.size <= maxSize;
    
    if (!isValidType) {
      fileError?.classList.remove('hidden');
      if (fileError) fileError.textContent = 'Please upload a PDF or DOCX file only.';
      return false;
    }
    
    if (!isValidSize) {
      fileError?.classList.remove('hidden');
      if (fileError) fileError.textContent = 'File size must be under 5MB.';
      return false;
    }
    
    fileError?.classList.add('hidden');
    return true;
  };
  
  // File input change handler
  resumeInput?.addEventListener('change', () => {
    const file = resumeInput.files?.[0];
    if (file && validateFile(file)) {
      if (resumeText) resumeText.textContent = file.name;
      resumeLabel?.classList.add('border-accent-500', 'bg-accent-50', 'dark:bg-accent-900/20');
    } else {
      resumeInput.value = '';
      if (resumeText) resumeText.textContent = 'Click to upload or drag and drop';
      resumeLabel?.classList.remove('border-accent-500', 'bg-accent-50', 'dark:bg-accent-900/20');
    }
  });
  
  // Drag and drop handlers
  resumeLabel?.addEventListener('dragover', (e) => {
    e.preventDefault();
    resumeLabel.classList.add('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
  });
  
  resumeLabel?.addEventListener('dragleave', () => {
    resumeLabel.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
  });
  
  resumeLabel?.addEventListener('drop', (e) => {
    e.preventDefault();
    resumeLabel.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
    
    const file = (e as DragEvent).dataTransfer?.files[0];
    if (file && validateFile(file)) {
      const dt = new DataTransfer();
      dt.items.add(file);
      resumeInput.files = dt.files;
      
      if (resumeText) resumeText.textContent = file.name;
      resumeLabel?.classList.add('border-accent-500', 'bg-accent-50', 'dark:bg-accent-900/20');
    }
  });
</script>
